name: facebook/flow/build_and_deploy
on:
  push:
    branches:
    - main
env:
  AWS_ACCESS_KEY_ID: xxxxUUFG
  AWS_SECRET_ACCESS_KEY: xxxxMSzY
  CLOUDFRONT_ID: xxxxZHP9
  CLOUDFRONT_ID_NEW_WEBSITE: xxxxUKJ4
  DOC_BOT_TOKEN: xxxxwpcy
  FLOW_BIN_PRIVATE_KEY_BASE64: xxxxLS0K
  FLOW_BOT_EMAIL: xxxx.com
  FLOW_BOT_TOKEN: xxxxX27z
  NPM_TOKEN: xxxxAJvJ
  S3_BUCKET: xxxx.org
  S3_BUCKET_NEW_WEBSITE: xxxxtorg
jobs:
  checkout:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: node:12
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: "./."
  build_js:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: flowtype/flow-ci:linux-x86_64
      env:
        TERM: dumb
        OPAMYES: true
    needs:
    - checkout
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - uses: "./.github/actions/make-opam-cachebreaker"
    - uses: "./.github/actions/restore-opam-cache"
    - name: Init opam
      run: ".circleci/opam_init.sh"
    - uses: "./.github/actions/create-opam-switch"
    - name: Install extra deps from opam
      run: make deps-js
    - uses: "./.github/actions/save-opam-cache"
    - name: Build flow.js
      run: opam exec -- make js
    - name: Build flow_parser.js
      run: opam exec -- make -C src/parser js
    - name: Create artifacts
      run: |-
        mkdir -p dist
        cp src/parser/flow_parser.js dist/flow_parser.js
        cp src/parser/flow_parser.js packages/flow-parser/flow_parser.js
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/flow.js
          ./dist/flow_parser.js
          ./packages/flow-parser/flow_parser.js
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: bin/flow.js
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/flow_parser.js
  build_linux:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: flowtype/flow-ci:linux-x86_64
      env:
        TERM: dumb
        OPAMYES: true
    needs:
    - checkout
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - uses: "./.github/actions/make-opam-cachebreaker"
    - uses: "./.github/actions/restore-opam-cache"
    - name: Init opam
      run: ".circleci/opam_init.sh"
    - uses: "./.github/actions/create-opam-switch"
    - name: Install extra deps from opam
      run: make deps-js
    - uses: "./.github/actions/save-opam-cache"
    - name: Build flow
      run: |-
        opam exec -- make bin/flow dist/flow.zip
        mkdir -p bin/linux && cp bin/flow bin/linux/flow
    - name: Build libflowparser
      run: opam exec -- make -C src/parser dist/libflowparser.zip
    - name: Create artifacts
      run: |-
        cp dist/flow.zip dist/flow-linux64.zip
        cp src/parser/dist/libflowparser.zip dist/libflowparser-linux64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/linux/flow
          ./dist/flow-linux64.zip
          ./dist/libflowparser-linux64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/flow-linux64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/libflowparser-linux64.zip
  build_linux_arm64:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-20.04
    needs:
    - checkout
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Start Docker image
      run: |-
        rm -rf /home/circleci/.opam && mkdir /home/circleci/.opam
        container_id=$(\
          docker run -it -d \
            --mount type=bind,source=/home/circleci/.opam,target=/home/opam/.opam \
            --mount type=bind,source=/home/circleci/flow,target=/home/opam/flow \
            flowtype/flow-ci:linux-arm64 \
            /bin/bash \
        )
        echo "export CONTAINER_ID=$container_id" >> $BASH_ENV
    - name: Create cache breaker
      run: docker exec -it $CONTAINER_ID /bin/bash -c 'cd flow && .circleci/make_opam_cachebreaker.sh > .circleci/opamcachebreaker'
    - uses: "./.github/actions/restore-opam-cache"
    - name: Init opam
      run: docker exec -it $CONTAINER_ID /bin/bash -c 'flow/.circleci/opam_init.sh'
    - name: Install opam deps
      run: docker exec -it $CONTAINER_ID /bin/bash -c 'cd flow && make deps'
    - uses: "./.github/actions/save-opam-cache"
    - name: Build flow
      run: |-
        docker exec -it $CONTAINER_ID /bin/bash -c 'cd flow && opam exec -- make bin/flow dist/flow.zip'
        mkdir -p bin/linux-arm64 && cp bin/flow bin/linux-arm64/flow
    - name: Build libflowparser
      run: docker exec -it $CONTAINER_ID /bin/bash -c 'cd flow && opam exec -- make -C src/parser dist/libflowparser.zip'
    - name: Stop Docker container
      run: docker stop $CONTAINER_ID
    - name: Create artifacts
      run: |-
        cp dist/flow.zip dist/flow-linux-arm64.zip
        cp src/parser/dist/libflowparser.zip dist/libflowparser-linux-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/linux-arm64/flow
          ./dist/flow-linux-arm64.zip
          ./dist/libflowparser-linux-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/flow-linux-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/libflowparser-linux-arm64.zip
  build_macos:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: macos-latest
    needs:
    - checkout
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: maxim-lobanov/setup-xcode@v1.6.0
      with:
        xcode-version: '13.4'
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Update curl cacerts
      run: echo "cacert /Users/$USER/flow/.circleci/cacert.pem" >> ~/.curlrc
    - uses: "./.github/actions/install-opam-mac"
      with:
        arch: x86_64
    - uses: "./.github/actions/make-opam-cachebreaker"
    - uses: "./.github/actions/restore-opam-cache"
    - name: Init opam
      run: ".circleci/opam_init.sh"
    - uses: "./.github/actions/create-opam-switch"
    - uses: "./.github/actions/save-opam-cache"
    - name: Build flow
      run: |-
        opam exec -- make bin/flow dist/flow.zip
        mkdir -p bin/macos && cp bin/flow bin/macos/flow
    - name: Build libflowparser
      run: opam exec -- make -C src/parser dist/libflowparser.zip
    - name: Create artifacts
      run: |-
        cp dist/flow.zip dist/flow-osx.zip
        cp src/parser/dist/libflowparser.zip dist/libflowparser-osx.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/macos/flow
          ./dist/flow-osx.zip
          ./dist/libflowparser-osx.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/flow-osx.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: src/parser/dist/libflowparser.zip
  build_macos_arm64:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: macos-latest
    needs:
    - checkout
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: maxim-lobanov/setup-xcode@v1.6.0
      with:
        xcode-version: 14.2.0
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Update curl cacerts
      run: echo "cacert /Users/$USER/flow/.circleci/cacert.pem" >> ~/.curlrc
    - uses: "./.github/actions/install-opam-mac"
      with:
        arch: arm64
    - uses: "./.github/actions/make-opam-cachebreaker"
    - uses: "./.github/actions/restore-opam-cache"
    - name: Init opam
      run: ".circleci/opam_init.sh"
    - uses: "./.github/actions/create-opam-switch"
    - uses: "./.github/actions/save-opam-cache"
    - name: Build flow
      run: |-
        opam exec -- make bin/flow dist/flow.zip
        mkdir -p bin/macos-arm64 && cp bin/flow bin/macos-arm64/flow
    - name: Build libflowparser
      run: opam exec -- make -C src/parser dist/libflowparser.zip
    - name: Create artifacts
      run: |-
        cp dist/flow.zip dist/flow-osx-arm64.zip
        cp src/parser/dist/libflowparser.zip dist/libflowparser-osx-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/macos-arm64/flow
          ./dist/flow-osx-arm64.zip
          ./dist/libflowparser-osx-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/flow-osx-arm64.zip
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: src/parser/dist/libflowparser-osx-arm64.zip
  build_win:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    needs:
    - checkout
    env:
      FLOW_TMP_DIR: C:\tmp\flow
      OPAMDOWNLOADJOBS: 1
    steps:
    - uses: actions/checkout@v4.1.0
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "."
    - name: Set up workspace
      run: New-Item -ItemType Directory $Env:FLOW_TMP_DIR
    - uses: "./.github/actions/install"
    - name: Create cache breaker
      run: |-
        cd "${{ github.workspace }}"
        /usr/bin/make print-switch > /cygdrive/c/tmp/flow/opamcachebreaker
        /usr/local/bin/opam --version >> /cygdrive/c/tmp/flow/opamcachebreaker
        /usr/bin/cat flowtype.opam >> /cygdrive/c/tmp/flow/opamcachebreaker
        /usr/bin/cat flow_parser.opam >> /cygdrive/c/tmp/flow/opamcachebreaker
        /usr/bin/cat .circleci/config.yml >> /cygdrive/c/tmp/flow/opamcachebreaker
      shell: C:/tools/cygwin/bin/bash.exe -leo pipefail
    - name: restore_cache
      uses: actions/cache@v3.3.2
      with:
        key: opam-cache-{{ arch }}-{{ checksum "C:/tmp/flow/opamcachebreaker" }}
        path: |-
          C:/tools/cygwin/home/circleci/.opam
          _opam
        restore-keys: opam-cache-{{ arch }}-{{ checksum "C:/tmp/flow/opamcachebreaker" }}
    - name: Init opam
      run: opam init default 'https://github.com/ocaml-opam/opam-repository-mingw.git#opam2' --bare --disable-sandboxing --no-setup
      shell: C:/tools/cygwin/bin/bash.exe -leo pipefail
    - name: Create opam switch
      run: |-
        cd "${{ github.workspace }}"
        make deps
      shell: C:/tools/cygwin/bin/bash.exe -leo pipefail
      env:
        PATH: "/usr/local/bin:/usr/bin:/cygdrive/c/Windows/system32:/cygdrive/c/Windows:/cygdrive/c/Windows/System32/Wbem:/cygdrive/c/Windows/System32/WindowsPowerShell/v1.0"
    - name: Build flow.exe
      run: |-
        cd "${{ github.workspace }}"
        eval $(opam env)
        make bin/flow.exe dist/flow.zip
        mkdir -p bin/win64 && cp bin/flow.exe bin/win64/flow.exe
        cp dist/flow.zip dist/flow-win64.zip
      shell: C:/tools/cygwin/bin/bash.exe -leo pipefail
      env:
        PATH: "/usr/local/bin:/usr/bin:/cygdrive/c/Windows/system32:/cygdrive/c/Windows:/cygdrive/c/Windows/System32/Wbem:/cygdrive/c/Windows/System32/WindowsPowerShell/v1.0"
    - name: Build parser test runner
      run: |-
        cd "${{ github.workspace }}"
        eval $(opam env)
        dune build src/parser/test/run_tests.exe
        cp _build/default/src/parser/test/run_tests.exe bin/win64/run_parser_tests.exe
      shell: C:/tools/cygwin/bin/bash.exe -leo pipefail
      env:
        PATH: "/usr/local/bin:/usr/bin:/cygdrive/c/Windows/system32:/cygdrive/c/Windows:/cygdrive/c/Windows/System32/Wbem:/cygdrive/c/Windows/System32/WindowsPowerShell/v1.0"
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./bin/win64/flow.exe
          ./dist/flow-win64.zip
          ./bin/win64/run_parser_tests.exe
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: ".\\dist\\flow-win64.zip"
  npm_pack:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: node:12
    needs:
    - build_js
    - build_linux
    - build_linux_arm64
    - build_macos
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Pack flow-parser
      run: |-
        mkdir -p packages/flow-parser/dist/
        cp dist/flow_parser.js packages/flow-parser/dist/flow_parser.js
        make dist/npm-flow-parser.tgz
    - name: Pack flow-parser-bin
      run: |-
        mkdir -p packages/flow-parser-bin/dist/release/
        cp dist/libflowparser-linux64.zip packages/flow-parser-bin/dist/release/libflowparser-linux64.zip
        cp dist/libflowparser-linux-arm64.zip packages/flow-parser-bin/dist/release/libflowparser-linux-arm64.zip
        cp dist/libflowparser-osx.zip packages/flow-parser-bin/dist/release/libflowparser-osx.zip
        make dist/npm-flow-parser-bin.tgz
    - name: Pack flow-remove-types and flow-node
      run: |-
        rm -rf packages/flow-node
        cp -r packages/flow-remove-types/ packages/flow-node/
        sed -i '0,/flow-remove-types/s//flow-node/' packages/flow-node/package.json
        make dist/npm-flow-remove-types.tgz
        make dist/npm-flow-node.tgz
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: |-
          ./dist/npm-flow-parser.tgz
          ./dist/npm-flow-parser-bin.tgz
          ./dist/npm-flow-node.tgz
          ./dist/npm-flow-remove-types.tgz
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/npm-flow-parser.tgz
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/npm-flow-parser-bin.tgz
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/npm-flow-node.tgz
    - uses: actions/upload-artifact@v3.1.3
      with:
        path: dist/npm-flow-remove-types.tgz
  npm_deploy:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: node:12
    needs:
    - npm_pack
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Deploy to npm
      run: ".circleci/deploy_npm.sh"
  github_linux:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: appropriate/curl:latest
    needs:
    - build_linux
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "/flow"
    - name: Upload Linux binary
      run: .circleci/github_upload.sh dist/flow-linux64.zip "flow-linux64-${{ github.ref }}.zip"
    - name: Upload Linux libflowparser
      run: .circleci/github_upload.sh dist/libflowparser-linux64.zip "libflowparser-linux64-${{ github.ref }}.zip"
  github_linux_arm64:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: appropriate/curl:latest
    needs:
    - build_linux_arm64
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "/flow"
    - name: Upload Linux binary
      run: .circleci/github_upload.sh dist/flow-linux-arm64.zip "flow-linux-arm64-${{ github.ref }}.zip"
    - name: Upload Linux libflowparser
      run: .circleci/github_upload.sh dist/libflowparser-linux-arm64.zip "libflowparser-linux-arm64-${{ github.ref }}.zip"
  github_macos:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: appropriate/curl:latest
    needs:
    - build_macos
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "/flow"
    - name: Upload Mac binary
      run: .circleci/github_upload.sh dist/flow-osx.zip "flow-osx-${{ github.ref }}.zip"
    - name: Upload Mac libflowparser
      run: .circleci/github_upload.sh dist/libflowparser-osx.zip "libflowparser-osx-${{ github.ref }}.zip"
  github_macos_arm64:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: appropriate/curl:latest
    needs:
    - build_macos_arm64
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "/flow"
    - name: Upload Mac binary
      run: .circleci/github_upload.sh dist/flow-osx-arm64.zip "flow-osx-arm64-${{ github.ref }}.zip"
    - name: Upload Mac libflowparser
      run: .circleci/github_upload.sh dist/libflowparser-osx-arm64.zip "libflowparser-osx-arm64-${{ github.ref }}.zip"
  github_win:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: appropriate/curl:latest
    needs:
    - build_win
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "/flow"
    - name: Upload Windows binary
      run: .circleci/github_upload.sh dist/flow-win64.zip "flow-win64-${{ github.ref }}.zip"
  flow_bin_deploy:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: node:12
    needs:
    - github_linux
    - github_linux_arm64
    - github_macos
    - github_win
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Deploy flow-bin
      run: ".circleci/deploy_flow_bin.sh"
  try_flow_deploy:
    if: # GitHub does not currently support regular expressions inside if conditions
#         (github.ref == 'refs/tags//^v.*/') && (github.ref != 'refs/heads//.*/')
    runs-on: ubuntu-latest
    container:
      image: node:12
    needs:
    - build_js
    steps:
    - uses: actions/download-artifact@v3.0.2
      with:
        path: "~/flow"
    - name: Assemble files
      run: |-
        cp bin/flow.js packages/try-flow-website-js/flow.js
        cp -r lib packages/try-flow-website-js/flowlib
        make dist/npm-try-flow-website-js.tgz
    - name: Deploy to NPM
      run: |-
        echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
        npm publish ./dist/npm-try-flow-website-js.tgz
